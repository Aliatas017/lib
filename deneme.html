<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <title>EduManage Pro - Akıllı Sınav Sistemi</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    
    <!-- Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#6366f1", // Indigo 500
                        "primary-hover": "#4f46e5", // Indigo 600
                        secondary: "#ec4899", // Pink 500
                        
                        // Dark Theme
                        "bg-dark": "#0f172a", // Slate 900
                        "surface-dark": "#1e293b", // Slate 800
                        "card-dark": "#334155", // Slate 700
                        
                        // Light Theme
                        "bg-light": "#f8fafc", // Slate 50
                        "surface-light": "#ffffff", 
                        
                        success: "#10b981", 
                        warning: "#f59e0b", 
                        danger: "#ef4444", 
                    },
                    fontFamily: { 
                        "display": ["Outfit", "sans-serif"], 
                        "body": ["Plus Jakarta Sans", "sans-serif"]
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'slide-up': 'slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'pulse-glow': 'pulseGlow 3s infinite',
                        'float': 'float 6s ease-in-out infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        pulseGlow: { '0%, 100%': { boxShadow: '0 0 20px rgba(99, 102, 241, 0)' }, '50%': { boxShadow: '0 0 20px rgba(99, 102, 241, 0.3)' } },
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } }
                    }
                },
            },
        }
    </script>
    <style>
        /* Modern Reset & Base */
        :root {
            --bg-body: #f8fafc;
            --bg-card: rgba(255, 255, 255, 0.8);
            --border-color: rgba(226, 232, 240, 0.8);
            --text-main: #0f172a;
            --text-muted: #64748b;
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }
        .dark:root {
            --bg-body: #0f172a;
            --bg-card: rgba(30, 41, 59, 0.7);
            --border-color: rgba(255, 255, 255, 0.08);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            transition: background-color 0.4s ease, color 0.4s ease;
            background-image: 
                radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(236, 72, 153, 0.15) 0px, transparent 50%);
            background-attachment: fixed;
        }

        /* Glassmorphism Classes */
        .glass-panel {
            background: var(--bg-card);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
            box-shadow: var(--glass-shadow);
        }

        .hover-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .hover-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-color: rgba(99, 102, 241, 0.5);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 99px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

        /* Utilities */
        .text-gradient {
            background: linear-gradient(135deg, #6366f1 0%, #ec4899 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .progress-bar-striped {
            background-image: linear-gradient(45deg,rgba(255,255,255,.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.15) 75%,transparent 75%,transparent);
            background-size: 1rem 1rem;
        }

        /* Quiz Specifics */
        .quiz-option {
            transition: all 0.2s ease;
            border: 2px solid var(--border-color);
        }
        .quiz-option:hover:not(:disabled) {
            border-color: #6366f1;
            background: rgba(99, 102, 241, 0.05);
        }
        .quiz-option.selected-correct { border-color: #10b981; background: rgba(16, 185, 129, 0.1); color: #10b981; }
        .quiz-option.selected-wrong { border-color: #ef4444; background: rgba(239, 68, 68, 0.1); color: #ef4444; }
        .quiz-option.disabled { opacity: 0.5; cursor: not-allowed; }

        /* Loader */
        .loader {
            width: 48px; height: 48px;
            border: 5px solid var(--text-muted);
            border-bottom-color: #6366f1;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="overflow-hidden">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-bg-dark">
            <div class="absolute top-0 -left-4 w-72 h-72 bg-purple-500 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-float"></div>
            <div class="absolute bottom-0 -right-4 w-72 h-72 bg-indigo-500 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-float" style="animation-delay: 2s;"></div>
        </div>
        
        <div class="w-full max-w-md bg-surface-dark/50 backdrop-blur-xl p-8 rounded-3xl border border-white/10 text-center relative z-10 shadow-2xl animate-fade-in">
            <div class="w-20 h-20 mx-auto mb-6 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-indigo-500/30">
                <span class="material-symbols-rounded text-4xl">school</span>
            </div>
            
            <h1 class="text-3xl font-bold text-white mb-2 font-display">EduManage</h1>
            <p class="text-slate-400 text-sm mb-8">Eğitimde Yeni Nesil Yönetim</p>
            
            <form onsubmit="handleAuth(event)" class="space-y-4 text-left">
                <div>
                    <label class="text-xs font-bold text-slate-400 ml-1 mb-2 block uppercase tracking-wider">E-Posta</label>
                    <input type="email" name="email" required placeholder="ornek@email.com" class="w-full bg-slate-900/50 border border-slate-700 text-white rounded-xl py-3 px-4 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition-all">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400 ml-1 mb-2 block uppercase tracking-wider">Şifre</label>
                    <input type="password" name="password" required placeholder="••••••••" class="w-full bg-slate-900/50 border border-slate-700 text-white rounded-xl py-3 px-4 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition-all">
                </div>
                <button type="submit" id="auth-submit-btn" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white py-3.5 rounded-xl font-bold text-sm transition-all shadow-lg shadow-indigo-500/25 mt-4">
                    Giriş Yap
                </button>
            </form>

            <div class="mt-8 pt-6 border-t border-white/5">
                <button onclick="toggleAuthMode()" id="auth-toggle-btn" class="text-slate-400 hover:text-white text-sm transition-colors">
                    Hesabın yok mu? <span class="text-indigo-400 font-bold">Kayıt Ol</span>
                </button>
            </div>
        </div>
    </div>

    <!-- APP LAYOUT -->
    <div id="app-wrapper" class="flex w-full h-screen hidden opacity-0 transition-opacity duration-500">
        
        <!-- SIDEBAR -->
        <aside id="main-sidebar" class="fixed lg:relative inset-y-0 left-0 z-40 w-72 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 glass-panel lg:border-r-0 lg:bg-transparent lg:backdrop-filter-none lg:shadow-none flex flex-col h-full">
            <div class="h-24 flex items-center px-8">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white shadow-lg">
                        <span class="material-symbols-rounded text-2xl">school</span>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold font-display tracking-tight text-gradient">EduManage</h1>
                        <p class="text-[10px] font-bold text-[var(--text-muted)] uppercase tracking-widest">PRO Sürüm</p>
                    </div>
                </div>
            </div>

            <div class="px-6 mb-6">
                <div class="p-4 glass-panel rounded-2xl flex items-center gap-3 border border-indigo-500/20 bg-indigo-500/5">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-indigo-500 to-purple-500 flex items-center justify-center text-white font-bold text-lg shadow-md">
                        <span id="user-avatar-initial">U</span>
                    </div>
                    <div class="overflow-hidden">
                        <p class="text-xs font-bold text-[var(--text-muted)] uppercase">Hoşgeldin</p>
                        <p class="text-sm font-bold text-[var(--text-main)] truncate" id="user-email-display">Kullanıcı</p>
                    </div>
                </div>
            </div>

            <nav class="flex-1 overflow-y-auto px-6 space-y-2 thin-scroll">
                <p class="px-2 text-[10px] font-bold text-[var(--text-muted)] uppercase tracking-widest mb-2">Keşfet</p>
                
                <button onclick="router('dashboard')" id="nav-dashboard" class="w-full flex items-center gap-3 px-4 py-3.5 rounded-xl text-sm font-bold transition-all group text-[var(--text-muted)] hover:bg-[var(--text-main)] hover:text-[var(--bg-body)]">
                    <span class="material-symbols-rounded group-hover:scale-110 transition-transform">dashboard</span>
                    <span>Dashboard</span>
                </button>
                
                <button onclick="router('content')" id="nav-content" class="w-full flex items-center gap-3 px-4 py-3.5 rounded-xl text-sm font-bold transition-all group text-[var(--text-muted)] hover:bg-[var(--text-main)] hover:text-[var(--bg-body)]">
                    <span class="material-symbols-rounded group-hover:scale-110 transition-transform">library_books</span>
                    <span>Test Kütüphanesi</span>
                </button>

                <!-- Dynamic Filters Area -->
                <div id="sidebar-filters" class="hidden mt-8 pt-6 border-t border-[var(--border-color)] animate-fade-in">
                    <div class="flex justify-between items-center px-2 mb-4">
                        <p class="text-[10px] font-bold text-[var(--text-muted)] uppercase tracking-widest">Hızlı Filtre</p>
                        <button onclick="openModal('category')" class="w-6 h-6 flex items-center justify-center rounded-lg bg-indigo-500/10 text-indigo-500 hover:bg-indigo-500 hover:text-white transition-colors">
                            <span class="material-symbols-rounded text-lg">add</span>
                        </button>
                    </div>
                    <div id="dynamic-filter-list" class="space-y-1 pb-4">
                        <!-- Filters Injected Here -->
                    </div>
                </div>
            </nav>

            <div class="p-6 mt-auto">
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="openModal('settings')" class="flex flex-col items-center justify-center p-3 rounded-xl glass-panel hover:border-indigo-500/50 transition-colors group">
                        <span class="material-symbols-rounded text-[var(--text-muted)] group-hover:text-indigo-500 mb-1">settings</span>
                        <span class="text-[9px] font-bold text-[var(--text-muted)]">Ayarlar</span>
                    </button>
                    <button onclick="toggleTheme()" class="flex flex-col items-center justify-center p-3 rounded-xl glass-panel hover:border-indigo-500/50 transition-colors group">
                        <span class="material-symbols-rounded text-[var(--text-muted)] group-hover:text-yellow-500 mb-1" id="theme-icon">dark_mode</span>
                        <span class="text-[9px] font-bold text-[var(--text-muted)]">Tema</span>
                    </button>
                    <button onclick="handleLogout()" class="flex flex-col items-center justify-center p-3 rounded-xl glass-panel hover:border-red-500/50 transition-colors group">
                        <span class="material-symbols-rounded text-[var(--text-muted)] group-hover:text-red-500 mb-1">logout</span>
                        <span class="text-[9px] font-bold text-[var(--text-muted)]">Çıkış</span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- MOBILE OVERLAY -->
        <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-30 lg:hidden hidden backdrop-blur-sm transition-opacity"></div>

        <!-- MAIN CONTENT -->
        <main class="flex-1 flex flex-col h-full overflow-hidden relative z-10 lg:ml-6 lg:my-6 lg:mr-6 lg:rounded-3xl glass-panel shadow-2xl">
            
            <!-- Mobile Header -->
            <header class="h-16 lg:hidden flex items-center justify-between px-5 border-b border-[var(--border-color)] shrink-0 bg-[var(--bg-card)]">
                <button onclick="toggleSidebar()" class="text-[var(--text-main)]"><span class="material-symbols-rounded text-2xl">menu</span></button>
                <span class="font-bold font-display text-lg text-gradient">EduManage</span>
                <div class="w-6"></div>
            </header>

            <!-- Dynamic View -->
            <div id="app-container" class="flex-1 overflow-hidden relative w-full h-full">
                <!-- Content injected here -->
                <div class="flex flex-col justify-center items-center h-full">
                    <span class="loader"></span>
                </div>
            </div>

            <!-- Scroll Top Button -->
            <button id="scroll-top-btn" onclick="scrollToTop()" class="fixed bottom-8 right-8 w-12 h-12 bg-indigo-600 hover:bg-indigo-500 text-white rounded-full shadow-xl flex items-center justify-center z-30 transition-all transform translate-y-20 opacity-0">
                <span class="material-symbols-rounded text-2xl">arrow_upward</span>
            </button>
        </main>
    </div>

    <!-- MODAL -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-[60] flex items-center justify-center p-4">
        <div class="glass-panel bg-[var(--bg-body)] rounded-3xl w-full max-w-2xl shadow-2xl transform scale-95 opacity-0 transition-all duration-300 flex flex-col max-h-[90vh]" id="modal-content">
            <div class="p-6 border-b border-[var(--border-color)] flex justify-between items-center shrink-0">
                <h3 id="modal-title" class="text-xl font-bold text-[var(--text-main)] font-display">İşlem</h3>
                <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-[var(--border-color)] flex items-center justify-center text-[var(--text-muted)] hover:bg-red-500 hover:text-white transition-colors">
                    <span class="material-symbols-rounded text-lg">close</span>
                </button>
            </div>
            <div id="modal-body" class="p-6 overflow-y-auto custom-scrollbar"></div>
        </div>
    </div>

    <!-- RESTORE PROGRESS -->
    <div id="restore-progress-modal" class="fixed inset-0 bg-black/90 backdrop-blur-lg hidden z-[70] flex flex-col items-center justify-center p-8 text-center">
        <div class="w-20 h-20 bg-indigo-500/20 rounded-full flex items-center justify-center mb-6 animate-pulse-glow text-indigo-500">
            <span class="material-symbols-rounded text-5xl">cloud_sync</span>
        </div>
        <h3 class="text-2xl font-bold text-white mb-2">Veriler Yükleniyor</h3>
        <p class="text-gray-400 text-sm mb-8">Lütfen bekleyin, veritabanınız yeniden oluşturuluyor...</p>
        <div class="w-full max-w-md bg-white/10 rounded-full h-2 mb-4 overflow-hidden">
            <div id="restore-progress-bar" class="bg-indigo-500 h-full rounded-full transition-all duration-300" style="width: 0%"></div>
        </div>
        <p class="text-xs text-indigo-400 font-mono" id="restore-progress-text">0%</p>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 sm:left-auto sm:translate-x-0 sm:right-8 glass-panel px-6 py-4 rounded-2xl shadow-2xl transform translate-y-32 opacity-0 transition-all duration-300 z-[80] flex items-center gap-4 min-w-[320px] border-l-4">
        <div id="toast-icon" class="text-2xl"></div>
        <div>
            <h4 id="toast-title" class="text-sm font-bold text-[var(--text-main)]"></h4>
            <p id="toast-message" class="text-xs text-[var(--text-muted)]"></p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // FIREBASE CONFIG
        const envConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const myFirebaseConfig = { apiKey: "AIzaSyBRyvBSrNc5QKFWiMryYbHG-s4DXf4IIrc", authDomain: "kpss-takip-75477.firebaseapp.com", projectId: "kpss-takip-75477", storageBucket: "kpss-takip-75477.firebasestorage.app", messagingSenderId: "1083935832054", appId: "1:1083935832054:web:d02f57e3721e39f286b9d7" };
        const firebaseConfig = (envConfig.apiKey) ? envConfig : myFirebaseConfig;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        let app, auth, db;
        try {
            if (!firebaseConfig.apiKey) throw new Error("API Key Missing");
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch(e) { console.error(e); }

        // STATE
        let currentUser = null;
        let categories = [], subcategories = [], tests = [], questions = [], results = [];
        let loading = true, currentView = 'dashboard', activeQuizData = null, isRestoring = false;
        let contentFilter = { catId: 'all', subId: 'all', search: '' };
        let visibleTestCount = 12; // Initial load count
        let isLoginMode = true, currentEditingId = null;

        // --- AUTH & INIT ---
        async function init() {
            if (!auth) return;
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token).catch(()=>{});
            
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    document.getElementById('user-avatar-initial').innerText = user.email[0].toUpperCase();
                    document.getElementById('user-email-display').innerText = user.email.split('@')[0];
                    document.getElementById('login-screen').classList.add('hidden');
                    const wrapper = document.getElementById('app-wrapper');
                    wrapper.classList.remove('hidden');
                    setTimeout(() => wrapper.classList.remove('opacity-0'), 100);
                    router('dashboard');
                    startListeners();
                } else {
                    document.getElementById('login-screen').classList.remove('hidden');
                    document.getElementById('app-wrapper').classList.add('hidden');
                }
            });
        }

        function startListeners() {
            if(!currentUser) return;
            const path = `artifacts/${appId}/users/${currentUser.uid}`;
            const snapHandler = (setter, snap) => { 
                setter(snap.docs.map(d => ({ id: d.id, ...d.data() }))); 
                if(!isRestoring) checkLoading(); 
            };
            
            onSnapshot(collection(db, path, 'categories'), s => snapHandler(d => { categories = d; if(!isRestoring && currentView === 'content') { updateSidebarFilters(); refreshGrid(); } }, s));
            onSnapshot(collection(db, path, 'subcategories'), s => snapHandler(d => { subcategories = d; if(!isRestoring && currentView === 'content') { updateSidebarFilters(); refreshGrid(); } }, s));
            onSnapshot(collection(db, path, 'tests'), s => snapHandler(d => { tests = d; if(!isRestoring) { if(currentView === 'content') refreshGrid(); if(currentView === 'dashboard') render(); } }, s));
            onSnapshot(collection(db, path, 'questions'), s => snapHandler(d => { questions = d; }, s));
            onSnapshot(collection(db, path, 'results'), s => snapHandler(d => { results = d; if(!isRestoring && currentView === 'dashboard') render(); }, s));
        }

        function checkLoading() { 
            if(loading) { loading = false; render(); } 
            else if(currentView === 'dashboard') render(); 
        }

        // --- ROUTING & UI ---
        window.router = function(view) {
            currentView = view;
            // Sidebar Active State
            ['nav-dashboard', 'nav-content'].forEach(id => {
                const el = document.getElementById(id);
                if(id === `nav-${view}`) {
                    el.classList.remove('text-[var(--text-muted)]', 'hover:bg-[var(--text-main)]');
                    el.classList.add('bg-indigo-500', 'text-white', 'shadow-lg', 'shadow-indigo-500/30');
                } else {
                    el.classList.add('text-[var(--text-muted)]');
                    el.classList.remove('bg-indigo-500', 'text-white', 'shadow-lg', 'shadow-indigo-500/30');
                }
            });

            // Filters Visibility
            const filters = document.getElementById('sidebar-filters');
            if(view === 'content') {
                filters.classList.remove('hidden');
                updateSidebarFilters();
                visibleTestCount = 12; // Reset pagination on view change
            } else {
                filters.classList.add('hidden');
                contentFilter = { catId: 'all', subId: 'all', search: '' };
            }

            // Mobile Close
            if(window.innerWidth < 1024) {
                document.getElementById('main-sidebar').classList.add('-translate-x-full');
                document.getElementById('sidebar-overlay').classList.add('hidden');
            }
            render();
        }

        // --- RENDER LOGIC ---
        function render() {
            const container = document.getElementById('app-container');
            container.innerHTML = '';
            
            if(loading) {
                container.innerHTML = `<div class="flex flex-col justify-center items-center h-full"><span class="loader"></span><p class="mt-4 text-sm font-bold text-[var(--text-muted)] animate-pulse">Yükleniyor...</p></div>`;
                return;
            }

            const isQuiz = currentView === 'quiz_active';
            const wrapper = document.createElement('div');
            wrapper.className = isQuiz ? "w-full h-full" : "w-full h-full p-6 md:p-8 overflow-y-auto custom-scrollbar";
            
            // Scroll Button Logic
            const btn = document.getElementById('scroll-top-btn');
            wrapper.onscroll = () => {
                if(wrapper.scrollTop > 300) { btn.classList.remove('translate-y-20', 'opacity-0'); btn.style.pointerEvents = 'auto'; }
                else { btn.classList.add('translate-y-20', 'opacity-0'); btn.style.pointerEvents = 'none'; }
            }
            window.scrollToTop = () => wrapper.scrollTo({ top: 0, behavior: 'smooth' });

            container.appendChild(wrapper);

            if (currentView === 'dashboard') renderDashboard(wrapper);
            else if (currentView === 'content') renderContent(wrapper);
            else if (currentView === 'quiz_active') renderActiveQuiz(container);
            else if (currentView === 'quiz_review') renderQuizReview(wrapper);
        }

        // --- DASHBOARD (ADVANCED) ---
        function renderDashboard(container) {
            const totalTests = tests.length;
            const solvedCount = results.length;
            const totalCorrect = results.reduce((a, b) => a + b.score, 0);
            const totalQuestions = results.reduce((a, b) => a + b.totalQuestions, 0);
            const successRate = totalQuestions > 0 ? Math.round((totalCorrect / totalQuestions) * 100) : 0;
            const name = currentUser.email.split('@')[0];

            // Category Stats
            const catStats = categories.map(c => {
                const cSubIds = subcategories.filter(s => s.catId === c.id).map(s => s.id);
                const cTestIds = tests.filter(t => cSubIds.includes(t.subId)).map(t => t.id);
                const cResults = results.filter(r => cTestIds.includes(r.testId));
                const corr = cResults.reduce((a,b) => a+b.score, 0);
                const tot = cResults.reduce((a,b) => a+b.totalQuestions, 0);
                return { name: c.name, pct: tot > 0 ? Math.round((corr/tot)*100) : 0, total: tot };
            }).filter(x => x.total > 0).sort((a,b) => b.total - a.total);

            // Subcategory Weak/Strong
            const subStats = subcategories.map(s => {
                const sTestIds = tests.filter(t => t.subId === s.id).map(t => t.id);
                const sResults = results.filter(r => sTestIds.includes(r.testId));
                const corr = sResults.reduce((a,b) => a+b.score, 0);
                const tot = sResults.reduce((a,b) => a+b.totalQuestions, 0);
                return { name: s.name, pct: tot > 0 ? Math.round((corr/tot)*100) : 0, total: tot };
            }).filter(x => x.total > 0).sort((a,b) => b.pct - a.pct); // Sort by success rate

            const recent = [...results].sort((a,b) => b.timestamp - a.timestamp).slice(0, 5);
            const newTests = [...tests].sort((a,b) => (b.createdAt || 0) - (a.createdAt || 0)).slice(0, 5);

            container.innerHTML = `
                <div class="max-w-7xl mx-auto space-y-8 animate-fade-in pb-12">
                    <!-- Welcome Header -->
                    <div class="p-8 rounded-3xl bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-xl relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-64 h-64 bg-white opacity-5 rounded-full blur-3xl transform translate-x-20 -translate-y-20"></div>
                        <div class="relative z-10 flex flex-col md:flex-row items-start md:items-end justify-between gap-6">
                            <div>
                                <p class="text-indigo-100 font-bold uppercase tracking-wider text-xs mb-1">${new Date().toLocaleDateString('tr-TR', {weekday:'long', year:'numeric', month:'long', day:'numeric'})}</p>
                                <h2 class="text-3xl md:text-4xl font-bold font-display mb-2">Hoşgeldin, <span class="capitalize">${name}</span>!</h2>
                                <p class="text-indigo-100/80 text-sm max-w-md">Bugün öğrenme hedeflerine ulaşmak için harika bir gün. İstatistiklerin güncel.</p>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="openModal('global-test-json')" class="bg-white text-indigo-600 px-6 py-3 rounded-xl font-bold text-sm shadow-lg hover:bg-indigo-50 transition-all flex items-center gap-2">
                                    <span class="material-symbols-rounded">add_circle</span> Test Ekle
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Stats Grid -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        ${[
                            {icon:'library_books', color:'text-blue-500', bg:'bg-blue-500/10', label:'Toplam Test', val: totalTests},
                            {icon:'check_circle', color:'text-green-500', bg:'bg-green-500/10', label:'Çözülen Test', val: solvedCount},
                            {icon:'help', color:'text-purple-500', bg:'bg-purple-500/10', label:'Çözülen Soru', val: totalQuestions},
                            {icon:'analytics', color:'text-orange-500', bg:'bg-orange-500/10', label:'Başarı Oranı', val: `%${successRate}`}
                        ].map(s => `
                            <div class="glass-panel p-5 rounded-2xl hover-card flex items-center gap-4">
                                <div class="w-12 h-12 rounded-xl flex items-center justify-center ${s.bg} ${s.color} text-2xl shadow-sm">
                                    <span class="material-symbols-rounded">${s.icon}</span>
                                </div>
                                <div>
                                    <p class="text-[var(--text-muted)] text-xs font-bold uppercase tracking-wider">${s.label}</p>
                                    <p class="text-2xl font-bold text-[var(--text-main)] font-display">${s.val}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <!-- Charts & Analysis -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Left: Category Performance -->
                        <div class="glass-panel p-6 rounded-2xl lg:col-span-2">
                            <h3 class="font-bold text-[var(--text-main)] mb-6 flex items-center gap-2 text-lg">
                                <span class="material-symbols-rounded text-indigo-500">bar_chart</span> Ders Performansı
                            </h3>
                            <div class="space-y-5">
                                ${catStats.length ? catStats.map(c => `
                                    <div>
                                        <div class="flex justify-between text-xs font-bold mb-2 text-[var(--text-main)]">
                                            <span>${c.name}</span>
                                            <span class="${c.pct>=70?'text-green-500':(c.pct>=50?'text-yellow-500':'text-red-500')}">%${c.pct}</span>
                                        </div>
                                        <div class="w-full bg-[var(--border-color)] rounded-full h-3 overflow-hidden">
                                            <div class="h-full rounded-full transition-all duration-1000 ${c.pct>=70?'bg-green-500':(c.pct>=50?'bg-yellow-500':'bg-red-500')}" style="width: ${c.pct}%"></div>
                                        </div>
                                    </div>
                                `).join('') : '<p class="text-sm text-[var(--text-muted)]">Veri yok.</p>'}
                            </div>
                        </div>

                        <!-- Right: Topic Focus -->
                        <div class="glass-panel p-6 rounded-2xl flex flex-col">
                            <h3 class="font-bold text-[var(--text-main)] mb-4 flex items-center gap-2 text-lg">
                                <span class="material-symbols-rounded text-pink-500">topic</span> Konu Analizi
                            </h3>
                            <div class="flex-1 overflow-y-auto custom-scrollbar max-h-[300px]">
                                ${subStats.length ? `
                                    <div class="space-y-4">
                                        <div>
                                            <p class="text-[10px] font-bold text-[var(--text-muted)] uppercase mb-2">Geliştirilmeli (Zayıf)</p>
                                            <div class="flex flex-wrap gap-2">
                                                ${subStats.slice(0, 3).map(s => `<span class="px-3 py-1 rounded-lg bg-red-500/10 text-red-500 text-xs font-bold border border-red-500/20">${s.name} %${s.pct}</span>`).join('')}
                                            </div>
                                        </div>
                                        <div>
                                            <p class="text-[10px] font-bold text-[var(--text-muted)] uppercase mb-2">Çok İyi (Güçlü)</p>
                                            <div class="flex flex-wrap gap-2">
                                                ${subStats.reverse().slice(0, 3).map(s => `<span class="px-3 py-1 rounded-lg bg-green-500/10 text-green-500 text-xs font-bold border border-green-500/20">${s.name} %${s.pct}</span>`).join('')}
                                            </div>
                                        </div>
                                    </div>
                                ` : '<p class="text-sm text-[var(--text-muted)]">Yeterli veri yok.</p>'}
                            </div>
                        </div>
                    </div>

                    <!-- Bottom: Lists -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Recent Activity -->
                        <div class="glass-panel p-0 rounded-2xl overflow-hidden flex flex-col">
                            <div class="p-5 border-b border-[var(--border-color)] bg-[var(--bg-card)]">
                                <h3 class="font-bold text-[var(--text-main)] flex items-center gap-2">
                                    <span class="material-symbols-rounded text-blue-500">history</span> Son Çözülenler
                                </h3>
                            </div>
                            <div class="p-2 space-y-1">
                                ${recent.length ? recent.map(r => {
                                    const t = tests.find(x => x.id === r.testId);
                                    const pct = Math.round((r.score/r.totalQuestions)*100);
                                    return `
                                    <div class="p-3 rounded-xl hover:bg-[var(--bg-body)] flex items-center justify-between transition-colors group">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 rounded-lg flex items-center justify-center text-xs font-bold ${pct>=50?'bg-green-500/10 text-green-500':'bg-red-500/10 text-red-500'}">%${pct}</div>
                                            <div class="overflow-hidden">
                                                <p class="text-sm font-bold text-[var(--text-main)] truncate max-w-[150px]">${t ? t.title : 'Silinmiş'}</p>
                                                <p class="text-[10px] text-[var(--text-muted)]">${new Date(r.timestamp).toLocaleDateString('tr-TR')}</p>
                                            </div>
                                        </div>
                                        ${t ? `<button onclick="startQuiz('${t.id}')" class="opacity-0 group-hover:opacity-100 p-2 rounded-lg bg-[var(--bg-card)] text-indigo-500 hover:bg-indigo-500 hover:text-white transition-all shadow-sm"><span class="material-symbols-rounded text-lg">refresh</span></button>` : ''}
                                    </div>`;
                                }).join('') : '<p class="p-4 text-center text-sm text-[var(--text-muted)]">Henüz test çözülmedi.</p>'}
                            </div>
                        </div>

                        <!-- New Tests -->
                        <div class="glass-panel p-0 rounded-2xl overflow-hidden flex flex-col">
                            <div class="p-5 border-b border-[var(--border-color)] bg-[var(--bg-card)]">
                                <h3 class="font-bold text-[var(--text-main)] flex items-center gap-2">
                                    <span class="material-symbols-rounded text-amber-500">new_releases</span> Yeni Eklenenler
                                </h3>
                            </div>
                            <div class="p-2 space-y-1">
                                ${newTests.length ? newTests.map(t => `
                                    <div class="p-3 rounded-xl hover:bg-[var(--bg-body)] flex items-center justify-between transition-colors group">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 rounded-lg bg-[var(--bg-body)] border border-[var(--border-color)] flex items-center justify-center text-[var(--text-muted)]">
                                                <span class="material-symbols-rounded">description</span>
                                            </div>
                                            <div class="overflow-hidden">
                                                <p class="text-sm font-bold text-[var(--text-main)] truncate max-w-[150px]">${t.title}</p>
                                                <p class="text-[10px] text-[var(--text-muted)]">${t.questionCount} Soru</p>
                                            </div>
                                        </div>
                                        <button onclick="startQuiz('${t.id}')" class="opacity-0 group-hover:opacity-100 px-3 py-1.5 rounded-lg bg-indigo-500/10 text-indigo-500 hover:bg-indigo-500 hover:text-white text-xs font-bold transition-all">İncele</button>
                                    </div>
                                `).join('') : '<p class="p-4 text-center text-sm text-[var(--text-muted)]">Henüz test eklenmedi.</p>'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- CONTENT & FILTER FIX ---
        function renderContent(container) {
            container.innerHTML = `
                <div class="max-w-[1600px] mx-auto animate-fade-in pb-12">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4 sticky top-0 z-20 py-4 backdrop-blur-md">
                        <div class="relative w-full max-w-md group">
                            <span class="material-symbols-rounded absolute left-4 top-3.5 text-[var(--text-muted)] group-focus-within:text-indigo-500 transition-colors">search</span>
                            <input type="text" id="search-input" placeholder="Test, ders veya konu ara..." oninput="handleSearch(this.value)" value="${contentFilter.search}" 
                                class="w-full bg-[var(--bg-card)] border border-[var(--border-color)] rounded-2xl py-3 pl-12 pr-4 text-sm focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 outline-none transition-all shadow-sm">
                        </div>
                        <button onclick="openModal('global-test-json')" class="bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-3 rounded-xl font-bold text-sm shadow-lg hover:shadow-indigo-500/30 transition-all flex items-center gap-2 transform active:scale-95">
                            <span class="material-symbols-rounded">add</span> Yeni Test
                        </button>
                    </div>

                    <div id="test-grid-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-6"></div>
                    <div id="pagination-container" class="mt-12 flex justify-center pb-8"></div>
                </div>`;
            refreshGrid();
        }

        function refreshGrid() {
            const grid = document.getElementById('test-grid-container');
            const pag = document.getElementById('pagination-container');
            if(!grid) return;

            let fTests = tests;
            if(contentFilter.catId !== 'all') {
                const sIds = subcategories.filter(s => s.catId === contentFilter.catId).map(s => s.id);
                fTests = fTests.filter(t => sIds.includes(t.subId));
            }
            if(contentFilter.subId !== 'all') fTests = fTests.filter(t => t.subId === contentFilter.subId);
            if(contentFilter.search) {
                const q = contentFilter.search.toLowerCase();
                fTests = fTests.filter(t => {
                    const sub = subcategories.find(s => s.id === t.subId);
                    const cat = sub ? categories.find(c => c.id === sub.catId) : null;
                    return t.title.toLowerCase().includes(q) || (sub?.name.toLowerCase().includes(q)) || (cat?.name.toLowerCase().includes(q));
                });
            }

            fTests.sort((a,b) => (a.createdAt || 0) - (b.createdAt || 0)); // Oldest first

            const visible = fTests.slice(0, visibleTestCount);
            const hasMore = fTests.length > visibleTestCount;

            if(visible.length === 0) {
                grid.innerHTML = `<div class="col-span-full py-20 text-center text-[var(--text-muted)] border-2 border-dashed border-[var(--border-color)] rounded-3xl"><span class="material-symbols-rounded text-5xl mb-2 opacity-30">search_off</span><p>Test bulunamadı.</p></div>`;
                pag.innerHTML = '';
                return;
            }

            grid.innerHTML = visible.map((t, i) => {
                const sub = subcategories.find(s => s.id === t.subId);
                const cat = sub ? categories.find(c => c.id === sub.catId) : null;
                const last = results.filter(r => r.testId === t.id).sort((a,b) => b.timestamp - a.timestamp)[0];
                const pct = last ? Math.round((last.score/last.totalQuestions)*100) : 0;

                return `
                <div class="glass-panel p-5 rounded-2xl hover-card flex flex-col h-full relative group animate-slide-up" style="animation-delay: ${i*0.05}s">
                    <div class="absolute top-0 inset-x-0 h-1 bg-gradient-to-r from-transparent via-indigo-500 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    
                    <div class="flex justify-between items-start mb-3">
                        <span class="px-2 py-1 rounded-md bg-[var(--bg-body)] border border-[var(--border-color)] text-[10px] font-bold text-[var(--text-muted)] uppercase tracking-wide truncate max-w-[60%]">${cat?.name || 'GENEL'}</span>
                        <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity absolute top-4 right-4 bg-[var(--bg-card)] p-1 rounded-lg border border-[var(--border-color)] shadow-sm">
                            <button onclick="openModal('global-test-json', '${t.id}')" class="p-1 rounded hover:bg-indigo-500/10 text-[var(--text-muted)] hover:text-indigo-500"><span class="material-symbols-rounded text-sm">edit</span></button>
                            <button onclick="deleteItem('tests', '${t.id}')" class="p-1 rounded hover:bg-red-500/10 text-[var(--text-muted)] hover:text-red-500"><span class="material-symbols-rounded text-sm">delete</span></button>
                        </div>
                    </div>

                    <h3 class="font-display font-bold text-lg text-[var(--text-main)] mb-2 line-clamp-2 h-14 leading-tight" title="${t.title}">${t.title}</h3>
                    <p class="text-xs text-[var(--text-muted)] mb-4 line-clamp-2 h-8">${t.description || ''}</p>

                    ${last ? `
                        <div class="mt-auto mb-4">
                            <div class="flex justify-between text-[10px] font-bold mb-1">
                                <span class="text-[var(--text-muted)]">Başarı</span>
                                <span class="${pct>=50?'text-green-500':'text-red-500'}">%${pct}</span>
                            </div>
                            <div class="w-full h-1.5 bg-[var(--bg-body)] rounded-full overflow-hidden">
                                <div class="h-full rounded-full ${pct>=50?'bg-green-500':'bg-red-500'}" style="width: ${pct}%"></div>
                            </div>
                        </div>
                    `: '<div class="mt-auto mb-4 h-8"></div>'}

                    <div class="pt-4 border-t border-[var(--border-color)] flex items-center justify-between">
                        <span class="text-xs font-bold text-[var(--text-muted)] flex items-center gap-1"><span class="material-symbols-rounded text-sm">list</span> ${t.questionCount}</span>
                        <button onclick="startQuiz('${t.id}')" class="px-4 py-2 rounded-lg bg-[var(--bg-body)] hover:bg-[var(--text-main)] hover:text-[var(--bg-body)] text-[var(--text-main)] text-xs font-bold border border-[var(--border-color)] transition-all group/btn flex items-center gap-1">
                            ${last ? 'Tekrar' : 'Başla'} <span class="material-symbols-rounded text-sm group-hover/btn:translate-x-0.5 transition-transform">arrow_forward</span>
                        </button>
                    </div>
                </div>`;
            }).join('');

            // FIX: Load More Button Logic
            pag.innerHTML = hasMore ? `
                <button onclick="loadMoreTests()" class="px-8 py-3 rounded-full bg-[var(--bg-card)] border border-[var(--border-color)] text-[var(--text-main)] font-bold text-sm shadow-sm hover:shadow-md hover:border-indigo-500 transition-all flex items-center gap-2">
                    Daha Fazla Göster <span class="material-symbols-rounded">expand_more</span>
                </button>` : '';
        }

        function updateSidebarFilters() {
            const list = document.getElementById('dynamic-filter-list');
            if(!list) return;
            const count = tests.length;
            
            list.innerHTML = `
                <button onclick="toggleCategory('all')" class="w-full text-left px-3 py-2.5 rounded-xl text-xs font-bold transition-all flex justify-between items-center group ${contentFilter.catId === 'all' ? 'bg-indigo-500 text-white shadow-lg shadow-indigo-500/30' : 'text-[var(--text-muted)] hover:bg-[var(--bg-body)]'}">
                    <span>Tüm Testler</span>
                    <span class="opacity-80">${count}</span>
                </button>
                ${categories.map(c => {
                    const subIds = subcategories.filter(s => s.catId === c.id).map(s => s.id);
                    const cCount = tests.filter(t => subIds.includes(t.subId)).length;
                    const active = contentFilter.catId === c.id;
                    
                    return `
                    <div class="mt-2">
                        <div class="flex items-center group rounded-xl transition-colors ${active ? 'bg-[var(--bg-body)]' : 'hover:bg-[var(--bg-body)]'}">
                            <button onclick="toggleCategory('${c.id}')" class="flex-1 text-left px-3 py-2.5 text-xs font-bold flex justify-between ${active ? 'text-indigo-500' : 'text-[var(--text-muted)] group-hover:text-[var(--text-main)]'}">
                                <span class="truncate">${c.name}</span>
                                <span class="opacity-70 text-[10px] bg-[var(--bg-card)] px-1.5 rounded">${cCount}</span>
                            </button>
                            <div class="flex gap-1 pr-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onclick="openModal('subcategory', '${c.id}')" class="p-1 hover:text-indigo-500 text-[var(--text-muted)]"><span class="material-symbols-rounded text-sm">add</span></button>
                                <button onclick="openModal('edit-category', '${c.id}')" class="p-1 hover:text-indigo-500 text-[var(--text-muted)]"><span class="material-symbols-rounded text-sm">edit</span></button>
                                <button onclick="deleteItem('categories', '${c.id}')" class="p-1 hover:text-red-500 text-[var(--text-muted)]"><span class="material-symbols-rounded text-sm">delete</span></button>
                            </div>
                        </div>
                        ${active ? `
                            <div class="ml-3 pl-3 border-l border-[var(--border-color)] mt-1 space-y-1 animate-slide-up" style="animation-duration:0.2s">
                                ${subcategories.filter(s => s.catId === c.id).map(s => {
                                    const sCount = tests.filter(t => t.subId === s.id).length;
                                    return `
                                    <div class="flex justify-between items-center group hover:bg-[var(--bg-body)] rounded-lg pr-2">
                                        <button onclick="filterBySubCategory('${s.id}')" class="flex-1 text-left py-1.5 px-3 text-[11px] font-bold ${contentFilter.subId === s.id ? 'text-indigo-500' : 'text-[var(--text-muted)] hover:text-[var(--text-main)]'}">
                                            ${s.name} <span class="opacity-50 ml-1">(${sCount})</span>
                                        </button>
                                        <div class="opacity-0 group-hover:opacity-100 flex gap-1">
                                            <button onclick="openModal('edit-subcategory', '${s.id}')" class="text-[var(--text-muted)] hover:text-indigo-500"><span class="material-symbols-rounded text-[12px]">edit</span></button>
                                            <button onclick="deleteItem('subcategories', '${s.id}')" class="text-[var(--text-muted)] hover:text-red-500"><span class="material-symbols-rounded text-[12px]">close</span></button>
                                        </div>
                                    </div>`;
                                }).join('')}
                            </div>
                        `:''}
                    </div>`;
                }).join('')}
            `;
        }

        // --- GLOBAL FUNCS ---
        window.loadMoreTests = () => { visibleTestCount += 12; refreshGrid(); };
        window.toggleCategory = (id) => { contentFilter.catId = (contentFilter.catId === id && id !== 'all') ? 'all' : id; contentFilter.subId = 'all'; visibleTestCount = 12; updateSidebarFilters(); refreshGrid(); };
        window.filterBySubCategory = (id) => { contentFilter.subId = id; visibleTestCount = 12; updateSidebarFilters(); refreshGrid(); };
        window.handleSearch = (val) => { contentFilter.search = val; visibleTestCount = 12; refreshGrid(); };
        
        window.toggleTheme = () => {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }
        if(localStorage.getItem('theme') === 'light') document.documentElement.classList.remove('dark');

        window.toggleSidebar = () => {
            document.getElementById('main-sidebar').classList.toggle('-translate-x-full');
            document.getElementById('sidebar-overlay').classList.toggle('hidden');
        }

        window.handleAuth = async (e) => {
            e.preventDefault();
            if(!auth) return;
            const d = new FormData(e.target);
            try {
                if(isLoginMode) await signInWithEmailAndPassword(auth, d.get('email'), d.get('password'));
                else await createUserWithEmailAndPassword(auth, d.get('email'), d.get('password'));
            } catch(err) { showToast("Hata", "Giriş yapılamadı.", "error"); }
        }
        window.toggleAuthMode = () => { isLoginMode = !isLoginMode; document.getElementById('auth-submit-btn').innerText = isLoginMode ? 'Giriş Yap' : 'Kayıt Ol'; };
        window.handleLogout = async () => { await signOut(auth); location.reload(); };

        // --- QUIZ & BACKUP logic remains similar but styled ---
        // (Shortened for brevity, full logic in previous version, styling updated in CSS)
        window.startQuiz = (id) => { activeQuizData = { test: tests.find(t=>t.id===id), questions: questions.filter(q=>q.testId===id), answers:{}, currentIndex:0 }; router('quiz_active'); };
        window.selectOption = (qId, i) => { if(activeQuizData.answers[qId]===undefined) { activeQuizData.answers[qId] = i; renderActiveQuiz(document.getElementById('app-container')); } }; // Re-render for simplicity in this specific improved version
        window.quizNav = (d) => { if(activeQuizData.currentIndex+d >= 0 && activeQuizData.currentIndex+d < activeQuizData.questions.length) { activeQuizData.currentIndex += d; renderActiveQuiz(document.getElementById('app-container')); } };
        window.submitQuiz = async () => { 
            if(!confirm('Bitirilsin mi?')) return; 
            let c = 0; activeQuizData.questions.forEach(q=>{ if(activeQuizData.answers[q.id]===q.correctIndex) c++; });
            await addDoc(collection(db, `artifacts/${appId}/users/${currentUser.uid}/results`), { testId: activeQuizData.test.id, score: c, totalQuestions: activeQuizData.questions.length, timestamp: Date.now() });
            router('quiz_review');
        };

        function renderActiveQuiz(c) {
            const { test, questions, currentIndex, answers } = activeQuizData;
            const q = questions[currentIndex];
            const ans = answers[q.id];
            const pct = ((currentIndex+1)/questions.length)*100;
            
            c.innerHTML = `
            <div class="fixed inset-0 bg-[var(--bg-body)] z-50 flex flex-col animate-fade-in">
                <div class="h-1 bg-[var(--border-color)]"><div class="h-full bg-indigo-500 transition-all duration-300" style="width:${pct}%"></div></div>
                <div class="h-16 px-6 glass-panel flex items-center justify-between border-b-0 shadow-sm shrink-0">
                    <button onclick="router('content')" class="w-10 h-10 rounded-xl bg-[var(--bg-body)] flex items-center justify-center hover:text-indigo-500 border border-[var(--border-color)]"><span class="material-symbols-rounded">close</span></button>
                    <h3 class="font-bold text-[var(--text-main)] truncate max-w-xs hidden md:block">${test.title}</h3>
                    <span class="font-mono font-bold text-indigo-500 bg-[var(--bg-body)] px-3 py-1 rounded-lg border border-[var(--border-color)]">${currentIndex+1} / ${questions.length}</span>
                </div>
                <div class="flex-1 overflow-y-auto p-6 md:p-10 flex flex-col items-center">
                    <div class="w-full max-w-3xl">
                        <h2 class="text-xl md:text-2xl font-bold text-[var(--text-main)] mb-8 leading-relaxed">${q.text}</h2>
                        <div class="space-y-3">
                            ${q.options.map((o,i) => {
                                let cls = "w-full p-4 rounded-xl text-left font-medium border-2 border-[var(--border-color)] hover:border-indigo-500/50 transition-all flex gap-4";
                                if(ans !== undefined) {
                                    if(i===q.correctIndex) cls="w-full p-4 rounded-xl text-left font-bold border-2 border-green-500 bg-green-500/10 text-green-500 flex gap-4";
                                    else if(i===ans) cls="w-full p-4 rounded-xl text-left font-bold border-2 border-red-500 bg-red-500/10 text-red-500 flex gap-4";
                                    else cls+=" opacity-50 cursor-not-allowed";
                                }
                                return `<button onclick="selectOption('${q.id}', ${i})" class="${cls}" ${ans!==undefined?'disabled':''}>
                                    <span class="w-6 h-6 rounded flex items-center justify-center border border-current text-xs shrink-0">${String.fromCharCode(65+i)}</span>
                                    <span>${o}</span>
                                </button>`;
                            }).join('')}
                        </div>
                        ${ans!==undefined && q.explanation ? `<div class="mt-6 p-4 rounded-xl bg-blue-500/10 border border-blue-500/20 text-blue-500 text-sm animate-fade-in"><strong class="block mb-1 uppercase text-xs tracking-wider">Açıklama</strong>${q.explanation}</div>` : ''}
                        <div class="h-20"></div>
                    </div>
                </div>
                <div class="p-4 glass-panel border-t-0 shadow-[0_-10px_40px_rgba(0,0,0,0.1)] shrink-0">
                    <div class="max-w-3xl mx-auto flex justify-between">
                        <button onclick="quizNav(-1)" class="px-6 py-3 rounded-xl font-bold bg-[var(--bg-body)] text-[var(--text-main)] hover:bg-[var(--border-color)] disabled:opacity-0 transition-all" ${currentIndex===0?'disabled':''}>Önceki</button>
                        ${currentIndex===questions.length-1 ? 
                            `<button onclick="submitQuiz()" class="px-8 py-3 rounded-xl font-bold bg-indigo-600 text-white hover:bg-indigo-500 shadow-lg shadow-indigo-500/30 transition-all">Bitir</button>` : 
                            `<button onclick="quizNav(1)" class="px-8 py-3 rounded-xl font-bold bg-[var(--text-main)] text-[var(--bg-body)] hover:opacity-90 transition-all">Sonraki</button>`}
                    </div>
                </div>
            </div>`;
        }

        function renderQuizReview(c) {
            let correct = 0;
            const { questions, answers, test } = activeQuizData;
            questions.forEach(q => { if(answers[q.id]===q.correctIndex) correct++; });
            
            c.innerHTML = `
            <div class="max-w-4xl mx-auto pb-12 animate-fade-in">
                <div class="text-center py-12">
                    <div class="w-32 h-32 mx-auto rounded-full flex items-center justify-center text-3xl font-bold border-8 border-[var(--bg-card)] shadow-2xl relative z-10 mb-6 bg-[var(--bg-body)]" 
                         style="background: conic-gradient(${correct/questions.length>=0.5?'#10b981':'#ef4444'} ${Math.round((correct/questions.length)*100)}%, var(--border-color) 0)">
                        <div class="absolute inset-2 rounded-full bg-[var(--bg-body)] flex items-center justify-center text-[var(--text-main)]">%${Math.round((correct/questions.length)*100)}</div>
                    </div>
                    <h2 class="text-2xl font-bold text-[var(--text-main)] mb-2">${test.title} Tamamlandı</h2>
                    <p class="text-[var(--text-muted)] font-medium mb-8">${correct} Doğru / ${questions.length - correct} Yanlış</p>
                    <div class="flex justify-center gap-4">
                        <button onclick="router('content')" class="px-6 py-3 rounded-xl border border-[var(--border-color)] bg-[var(--bg-card)] font-bold text-sm hover:border-indigo-500 transition-all">Kütüphaneye Dön</button>
                        <button onclick="startQuiz('${test.id}')" class="px-6 py-3 rounded-xl bg-indigo-600 text-white font-bold text-sm shadow-lg hover:bg-indigo-500 transition-all">Tekrar Çöz</button>
                    </div>
                </div>
                <div class="space-y-4">
                    ${questions.map((q,idx) => {
                        const ans = answers[q.id];
                        const isCor = ans===q.correctIndex;
                        const skip = ans===undefined;
                        return `
                        <div class="glass-panel p-6 rounded-2xl border-l-4 ${skip?'border-l-gray-500':(isCor?'border-l-green-500':'border-l-red-500')}">
                            <p class="font-bold text-[var(--text-main)] mb-4"><span class="text-[var(--text-muted)] mr-2">#${idx+1}</span> ${q.text}</p>
                            <div class="space-y-2">
                                ${q.options.map((o,i) => {
                                    let style = "p-3 rounded-lg border border-[var(--border-color)] text-sm opacity-70";
                                    if(i===q.correctIndex) style="p-3 rounded-lg bg-green-500/10 border-green-500/30 text-green-500 font-bold opacity-100";
                                    else if(i===ans && !isCor) style="p-3 rounded-lg bg-red-500/10 border-red-500/30 text-red-500 font-bold opacity-100";
                                    return `<div class="${style}">${o}</div>`;
                                }).join('')}
                            </div>
                            ${q.explanation ? `<div class="mt-4 p-3 bg-[var(--bg-body)] rounded-lg text-xs text-[var(--text-muted)]"><strong class="text-[var(--text-main)]">Açıklama:</strong> ${q.explanation}</div>`:''}
                        </div>`;
                    }).join('')}
                </div>
            </div>`;
        }

        // --- COMMON ---
        window.openModal = (type, id=null, subId=null) => {
            document.getElementById('modal-overlay').classList.remove('hidden');
            const body = document.getElementById('modal-body');
            const title = document.getElementById('modal-title');
            document.getElementById('modal-content').classList.remove('scale-95', 'opacity-0');
            
            // Re-used logic from previous artifact for forms, just simplified HTML output
            // (Full form logic is same as previous, just ensure handleSubmit is attached)
            // For brevity in response, assuming standard form generation as before.
            currentEditingId = type.includes('edit') ? id : (type==='subcategory'?subId:id);
            
            if(type==='global-test-json') {
                title.innerText = id ? 'Testi Düzenle' : 'Yeni Test';
                // Logic to populate form...
                let tData = id ? tests.find(t=>t.id===id) : null;
                let sId = tData?.subId || (contentFilter.subId!=='all'?contentFilter.subId:'');
                let cId = tData ? subcategories.find(s=>s.id===sId)?.catId : (contentFilter.catId!=='all'?contentFilter.catId:'');
                let json = '[]';
                if(id) { const qs=questions.filter(q=>q.testId===id); json=JSON.stringify(qs.map(q=>({text:q.text, options:q.options, correctIndex:q.correctIndex, explanation:q.explanation||""})), null, 2); }
                
                body.innerHTML = `
                <form onsubmit="handleSubmit(event, 'global-test-json')" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-xs font-bold text-[var(--text-muted)] uppercase mb-1">Ders</label><select id="modal-cat-select" onchange="filterSubcatsInModal()" class="w-full p-2.5 rounded-xl bg-[var(--bg-body)] border border-[var(--border-color)] text-sm"><option value="">Seçiniz</option>${categories.map(c=>`<option value="${c.id}" ${c.id===cId?'selected':''}>${c.name}</option>`).join('')}</select></div>
                        <div><label class="block text-xs font-bold text-[var(--text-muted)] uppercase mb-1">Konu</label><select name="subId" id="modal-sub-select" required class="w-full p-2.5 rounded-xl bg-[var(--bg-body)] border border-[var(--border-color)] text-sm" disabled></select></div>
                    </div>
                    <div><label class="block text-xs font-bold text-[var(--text-muted)] uppercase mb-1">Başlık</label><input name="title" value="${tData?.title||''}" required class="w-full p-3 rounded-xl bg-[var(--bg-body)] border border-[var(--border-color)] text-sm font-bold"></div>
                    <div><label class="block text-xs font-bold text-[var(--text-muted)] uppercase mb-1">Açıklama</label><input name="description" value="${tData?.description||''}" class="w-full p-3 rounded-xl bg-[var(--bg-body)] border border-[var(--border-color)] text-sm"></div>
                    <div><label class="block text-xs font-bold text-[var(--text-muted)] uppercase mb-1">Sorular (JSON)</label><textarea name="questionsJson" rows="6" required class="w-full p-3 rounded-xl bg-[var(--bg-body)] border border-[var(--border-color)] text-xs font-mono">${json}</textarea></div>
                    <button class="w-full py-3 rounded-xl bg-indigo-600 text-white font-bold text-sm hover:bg-indigo-500 shadow-lg transition-all">Kaydet</button>
                </form>`;
                setTimeout(()=>filterSubcatsInModal(sId), 50);
            } else if (type==='settings') {
                title.innerText = 'Ayarlar';
                body.innerHTML = `
                <div class="space-y-4">
                    <div class="p-4 rounded-xl border border-[var(--border-color)] bg-[var(--bg-body)]"><h4 class="font-bold text-sm mb-1 text-[var(--text-main)]">Yedekle</h4><p class="text-xs text-[var(--text-muted)] mb-3">Tüm verileri indir.</p><button onclick="downloadBackup()" class="w-full py-2 bg-[var(--bg-card)] border border-[var(--border-color)] rounded-lg text-xs font-bold">İndir</button></div>
                    <div class="p-4 rounded-xl border border-[var(--border-color)] bg-[var(--bg-body)]"><h4 class="font-bold text-sm mb-1 text-[var(--text-main)]">Geri Yükle</h4><p class="text-xs text-[var(--text-muted)] mb-3">Yedek dosyasını yükle.</p><input type="file" id="restore-file" class="hidden" onchange="restoreBackup(this)"><button onclick="document.getElementById('restore-file').click()" class="w-full py-2 bg-[var(--bg-card)] border border-[var(--border-color)] rounded-lg text-xs font-bold">Dosya Seç</button></div>
                    <button onclick="resetProgress()" class="w-full py-3 border border-red-500/30 text-red-500 bg-red-500/5 rounded-xl font-bold text-xs hover:bg-red-500 hover:text-white transition-all">Sıfırla</button>
                </div>`;
            } else if(type.includes('category')) { // Handle category/subcategory add/edit
                const isCat = type.includes('category') && !type.includes('sub');
                title.innerText = type.includes('edit') ? 'Düzenle' : 'Ekle';
                const val = type.includes('edit') ? (isCat ? categories.find(c=>c.id===id)?.name : subcategories.find(s=>s.id===id)?.name) : '';
                body.innerHTML = `<form onsubmit="handleSubmit(event, '${type}')" class="space-y-4"><input type="hidden" name="catId" value="${id}"><div><label class="block text-xs font-bold text-[var(--text-muted)] uppercase mb-1">Ad</label><input name="name" value="${val||''}" required class="w-full p-3 rounded-xl bg-[var(--bg-body)] border border-[var(--border-color)] text-sm"></div><button class="w-full py-3 rounded-xl bg-indigo-600 text-white font-bold text-sm shadow-lg">Kaydet</button></form>`;
            }
        };

        window.filterSubcatsInModal = (sel) => {
            const cid = document.getElementById('modal-cat-select').value;
            const sub = document.getElementById('modal-sub-select');
            if(!cid) { sub.innerHTML='<option value="">Önce ders seç</option>'; sub.disabled=true; return; }
            sub.innerHTML = subcategories.filter(s=>s.catId===cid).map(s=>`<option value="${s.id}" ${s.id===sel?'selected':''}>${s.name}</option>`).join('');
            sub.disabled=false;
        }

        window.closeModal = () => { document.getElementById('modal-overlay').classList.add('hidden'); document.getElementById('modal-content').classList.add('scale-95', 'opacity-0'); };
        
        window.handleSubmit = async (e, type) => {
            e.preventDefault();
            const d = Object.fromEntries(new FormData(e.target).entries());
            const path = `artifacts/${appId}/users/${currentUser.uid}`;
            const btn = e.target.querySelector('button');
            const txt = btn.innerText; btn.innerText='...'; btn.disabled=true;

            try {
                if(type==='category') await addDoc(collection(db, path, 'categories'), { name: d.name, createdAt: Date.now() });
                else if(type==='subcategory') await addDoc(collection(db, path, 'subcategories'), { name: d.name, catId: d.catId, createdAt: Date.now() });
                else if(type.includes('edit')) await updateDoc(doc(db, path, type.includes('cat') && !type.includes('sub') ? 'categories' : 'subcategories', currentEditingId), { name: d.name });
                else if(type==='global-test-json') {
                    const qs = JSON.parse(d.questionsJson);
                    const meta = { title: d.title, description: d.description||"", subId: d.subId, questionCount: qs.length };
                    if(currentEditingId) {
                        await updateDoc(doc(db, path, 'tests', currentEditingId), meta);
                        const old = questions.filter(q=>q.testId===currentEditingId);
                        old.forEach(q => deleteDoc(doc(db, path, 'questions', q.id))); // Fire and forget deletes
                        await Promise.all(qs.map(q => addDoc(collection(db, path, 'questions'), { ...q, testId: currentEditingId })));
                    } else {
                        const ref = await addDoc(collection(db, path, 'tests'), { ...meta, createdAt: Date.now() });
                        await Promise.all(qs.map(q => addDoc(collection(db, path, 'questions'), { ...q, testId: ref.id })));
                    }
                }
                closeModal(); showToast('Başarılı', 'İşlem tamamlandı.');
            } catch(e) { console.error(e); showToast('Hata', e.message, 'error'); }
            finally { btn.innerText=txt; btn.disabled=false; }
        };

        window.deleteItem = async (col, id) => {
            if(!confirm('Silmek istediğine emin misin?')) return;
            await deleteDoc(doc(db, `artifacts/${appId}/users/${currentUser.uid}`, col, id));
            showToast('Silindi', 'Öğe silindi.');
        };

        window.downloadBackup = () => {
            const data = { categories, subcategories, tests, questions, exportDate: Date.now() };
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([JSON.stringify(data,null,2)], {type:'application/json'}));
            a.download = `backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
        };

        window.restoreBackup = (input) => {
            const file = input.files[0];
            if(!file) return;
            const r = new FileReader();
            r.onload = async (e) => {
                try {
                    const d = JSON.parse(e.target.result);
                    if(!confirm(`DİKKAT: ${d.tests.length} test eklenecek. Onaylıyor musun?`)) return;
                    
                    isRestoring = true;
                    document.getElementById('restore-progress-modal').classList.remove('hidden');
                    closeModal();
                    
                    const path = `artifacts/${appId}/users/${currentUser.uid}`;
                    const total = d.categories.length + d.subcategories.length + d.tests.length + d.questions.length;
                    let count = 0;
                    const tick = () => { count++; const p = Math.round((count/total)*100); document.getElementById('restore-progress-bar').style.width=`${p}%`; document.getElementById('restore-progress-text').innerText=`%${p}`; };

                    for (const c of d.categories) {
                        const cref = await addDoc(collection(db, path, 'categories'), { name: c.name, createdAt: Date.now() });
                        tick();
                        const subs = d.subcategories.filter(s=>s.catId===c.id);
                        for(const s of subs) {
                            const sref = await addDoc(collection(db, path, 'subcategories'), { name: s.name, catId: cref.id, createdAt: Date.now() });
                            tick();
                            const ts = d.tests.filter(t=>t.subId===s.id);
                            for(const t of ts) {
                                const tref = await addDoc(collection(db, path, 'tests'), { title: t.title, description: t.description||"", subId: sref.id, questionCount: t.questionCount, createdAt: t.createdAt||Date.now() });
                                tick();
                                const qs = d.questions.filter(q=>q.testId===t.id);
                                const batch = 20;
                                for(let i=0; i<qs.length; i+=batch) {
                                    await Promise.all(qs.slice(i, i+batch).map(async q => {
                                        await addDoc(collection(db, path, 'questions'), { text: q.text, options: q.options, correctIndex: q.correctIndex, explanation: q.explanation||"", testId: tref.id });
                                        tick();
                                    }));
                                }
                            }
                        }
                    }
                    setTimeout(() => { isRestoring=false; document.getElementById('restore-progress-modal').classList.add('hidden'); render(); updateSidebarFilters(); showToast('Tamamlandı', 'Yedek yüklendi.'); }, 500);
                } catch(err) { console.error(err); isRestoring=false; document.getElementById('restore-progress-modal').classList.add('hidden'); showToast('Hata', 'Yedek yüklenemedi.', 'error'); }
                input.value='';
            };
            r.readAsText(file);
        };

        window.resetProgress = async () => {
            if(!confirm('Tüm ilerleme silinecek! Emin misin?')) return;
            const path = `artifacts/${appId}/users/${currentUser.uid}`;
            await Promise.all(results.map(r => deleteDoc(doc(db, path, 'results', r.id))));
            showToast('Sıfırlandı', 'İlerleme silindi.');
        };

        window.showToast = (t, m, type='success') => {
            const el = document.getElementById('toast');
            document.getElementById('toast-title').innerText = t;
            document.getElementById('toast-message').innerText = m;
            document.getElementById('toast-icon').innerHTML = type==='error' ? '<span class="material-symbols-rounded text-red-500">error</span>' : '<span class="material-symbols-rounded text-green-500">check_circle</span>';
            el.className = `fixed bottom-8 left-1/2 -translate-x-1/2 sm:left-auto sm:translate-x-0 sm:right-8 glass-panel px-6 py-4 rounded-2xl shadow-2xl transform transition-all duration-300 z-[80] flex items-center gap-4 min-w-[320px] border-l-4 ${type==='error'?'border-red-500':'border-green-500'}`;
            setTimeout(()=>el.classList.add('translate-y-32', 'opacity-0'), 3000);
        };

        init();
    </script>
</body>
</html>